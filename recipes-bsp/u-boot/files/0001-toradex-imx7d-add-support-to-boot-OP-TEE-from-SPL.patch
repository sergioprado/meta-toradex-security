From 1fdb34d8657601c609658a6910fce1eb46d7d24f Mon Sep 17 00:00:00 2001
From: Sergio Prado <sergio.prado@e-labworks.com>
Date: Tue, 17 Dec 2024 21:39:32 -0300
Subject: [PATCH] toradex: imx7d: add support to boot OP-TEE from SPL

Upstream-Status: Pending

Signed-off-by: Sergio Prado <sergio.prado@e-labworks.com>
---
 arch/arm/dts/imx7d-colibri-emmc.dtsi | 62 ++++++++++++++++++++++++++++
 arch/arm/mach-imx/mx7/Kconfig        |  1 +
 2 files changed, 63 insertions(+)

diff --git a/arch/arm/dts/imx7d-colibri-emmc.dtsi b/arch/arm/dts/imx7d-colibri-emmc.dtsi
index 2fb4d2133a1b..a31d64ef7571 100644
--- a/arch/arm/dts/imx7d-colibri-emmc.dtsi
+++ b/arch/arm/dts/imx7d-colibri-emmc.dtsi
@@ -5,6 +5,7 @@
 
 #include "imx7d.dtsi"
 #include "imx7-colibri.dtsi"
+#include <config.h>
 
 / {
 	aliases {
@@ -17,6 +18,67 @@
 		device_type = "memory";
 		reg = <0x80000000 0x40000000>;
 	};
+
+#if defined(CONFIG_SPL_OPTEE_IMAGE)
+	reserved-memory {
+		#address-cells = <1>;
+		#size-cells = <1>;
+		ranges;
+
+		optee@8c000000 {
+			reg = <0x8c000000 0x01000000>;
+			no-map;
+		};
+	};
+
+	binman {
+		fit {
+			description = "FIT image with OP-TEE";
+			fit,fdt-list = "of-list";
+			#address-cells = <1>;
+			filename = "u-boot.itb";
+			images {
+				u-boot {
+					description = "U-Boot";
+					type = "standalone";
+					os = "U-Boot";
+					arch = "arm";
+					compression = "none";
+					load = <CONFIG_TEXT_BASE>;
+					entry = <CONFIG_TEXT_BASE>;
+					u-boot-nodtb {
+					};
+				};
+				op-tee {
+					description = "OP-TEE";
+					type = "tee";
+					arch = "arm";
+					os = "tee";
+					compression = "none";
+					load = <0x8c000000>;
+					entry = <0x8c000000>;
+					tee-os {
+					};
+				};
+				@fdt-SEQ {
+					description = "fdt-NAME";
+					compression = "none";
+					type = "flat_dt";
+					arch = "arm";
+				};
+			};
+			configurations {
+				default = "@config-DEFAULT-SEQ";
+				@config-SEQ {
+					description = "NAME.dtb";
+					fdt = "fdt-SEQ";
+					fit,firmware = "op-tee", "u-boot";
+					fit,loadables;
+				};
+			};
+		};
+	};
+#endif
 };
 
 &cpu1 {
diff --git a/arch/arm/mach-imx/mx7/Kconfig b/arch/arm/mach-imx/mx7/Kconfig
index 9220335022b9..23018074d632 100644
--- a/arch/arm/mach-imx/mx7/Kconfig
+++ b/arch/arm/mach-imx/mx7/Kconfig
@@ -95,6 +95,7 @@ config TARGET_COLIBRI_IMX7
 	select DM_THERMAL
 	select MX7D
 	select SUPPORT_SPL
+	select BINMAN if SPL_OPTEE_IMAGE
 	imply CMD_DM
 
 endchoice
-- 
2.34.1

